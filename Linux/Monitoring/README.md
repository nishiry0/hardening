# ファイル監視用スクリプト

1. **設定ファイルの読み込み**
    
    スクリプトは、`filemon.conf` という設定ファイルを読み込みます。このファイルには、監視対象のディレクトリ、ログファイルのパス、並行処理のフラグ（`PARALLELISM`）、およびスリープ時間（`SLEEP_INTERVAL`）が記載されています。
    
2. **ディレクトリリストの配列化**
    
    監視対象のディレクトリ (`WATCH_DIRS`) を読み込み、リストに変換して後の処理で使いやすくします。
    
3. **ハッシュ計算とファイル所有者情報取得**
    1. `calculate_hash`: ファイルのMD5ハッシュを計算します。ハッシュ値を使ってファイルが変更されたかを確認します。
    2. `get_file_owner`: ファイルの所有者を取得します。新規ファイルや変更されたファイルの所有者情報をログに記録するために使用します。
4. **クリーンアップ処理 (`cleanup`)**
    
    スクリプト終了時やシグナル（`SIGINT`, `SIGTERM`）が送信された際に呼び出されます。すべてのバックグラウンドプロセスを終了させ、メッセージを出力して正常に終了したことを通知します。
    
5. **ディレクトリ監視 (`monitor_directory`)**
    
    指定されたディレクトリのファイルを監視します。
    
    1. 初回実行時には、ファイルのハッシュ値を初期化し、`hashes_ディレクトリ名.txt` に保存します。
    2. その後、ファイルの変更や削除、新規ファイルの検出を行い、検出結果をログに記録します。
    3. 並行処理モードでは無限ループで監視し、順次処理モードでは1回だけ監視して終了します。
6. **並行処理と順次処理の切り替え**
    1. `PARALLELISM=true` の場合、各ディレクトリを並行してバックグラウンドで監視し、各プロセスが終了するまで待機します。各監視プロセスは無限ループで監視を続けます。
    2. `PARALLELISM=false` の場合、ディレクトリを1つずつ順番に監視し、すべてのディレクトリを監視した後に一定の時間（`SLEEP_INTERVAL`）スリープして再度監視を行います。
7. **ログ出力**
    
    すべての変更、削除、追加されたファイルについて、検出時の情報を `LOG_FILE` に書き込みます。